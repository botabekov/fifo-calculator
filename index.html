<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>–ö–∞–ª—å–∫—É–ª—è—Ç–æ—Ä FIFO ‚Äî —Å—Ç–∏–ª—å–Ω–∞—è –≤–µ—Ä—Å–∏—è</title>

  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">

  <style>
    *, *::before, *::after { box-sizing: border-box; }

    :root{
      --bg:#f6f8fb;
      --card:#ffffff;
      --ink:#0f172a;
      --muted:#64748b;
      --line:#e5e7eb;

      --primary:#2563eb;
      --primary2:#1d4ed8;

      --success1:#10b981;
      --success2:#059669;

      --danger:#ef4444;
      --danger2:#dc2626;

      --shadow: 0 12px 30px rgba(2, 8, 23, .08);
      --shadow2: 0 2px 10px rgba(2, 8, 23, .06);

      --r12:12px;
      --r16:16px;
    }

    /* ===== FULLSCREEN LAYOUT ===== */
    html, body{
      height:100%;
      margin:0;
    }
    body{
      font-family: Inter, system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
      color:var(--ink);
      background:
        radial-gradient(1200px 600px at 10% -10%, rgba(37,99,235,.10), transparent 60%),
        radial-gradient(900px 600px at 100% 0%, rgba(16,185,129,.10), transparent 55%),
        var(--bg);
      overflow:hidden; /* —Å–∫—Ä–æ–ª–ª –±—É–¥–µ—Ç –≤–Ω—É—Ç—Ä–∏ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞ */
    }

    .container{
      width:100vw;
      height:100vh;
      max-width:none;
      margin:0;
      padding: 18px;
      background: var(--card);
      border: 0;
      border-radius: 0;
      box-shadow: none;
      position: relative;
      overflow: hidden;

      display:flex;
      flex-direction: column;
      gap: 10px;
    }

    h2{
      margin: 4px 0 2px;
      font-size: 22px;
      letter-spacing: -0.02em;
      text-align:center;
    }

    .subtitle{
      text-align:center;
      color:var(--muted);
      font-size: 13px;
      margin: 0 0 2px;
    }

    .flower-row{
      text-align:center;
      margin: 0 0 4px;
      opacity: .9;
      font-size: 16px;
    }

    .instruction{
      display:flex;
      gap:10px;
      align-items:flex-start;
      background: #fff7ed;
      border:1px solid #fed7aa;
      color:#7c2d12;
      border-radius: var(--r12);
      padding: 10px 12px;
      font-size: 13px;
      line-height: 1.35;
      margin: 0;
      flex: 0 0 auto;
    }
    .instruction:before{
      content:"üí°";
      font-size: 16px;
      line-height: 1.2;
      margin-top: 1px;
    }

    /* –¢–∞–±–ª–∏—Ü–∞ –¥–æ–ª–∂–Ω–∞ –∑–∞–Ω–∏–º–∞—Ç—å –≤—Å—ë –¥–æ—Å—Ç—É–ø–Ω–æ–µ –º–µ—Å—Ç–æ –∏ —Å–∫—Ä–æ–ª–ª–∏—Ç—å—Å—è */
    .tableWrap{
      flex: 1 1 auto;
      overflow:auto;
      border-radius: var(--r12);
      box-shadow: var(--shadow2);
      border:1px solid var(--line);
      margin: 0;
      min-height: 180px;
    }

    table{
      width:100%;
      border-collapse:separate;
      border-spacing:0;
      font-size: 13px;
      table-layout:fixed;
      min-width: 980px; /* —á—Ç–æ–±—ã —Ä–∞—Å—á—ë—Ç–Ω—ã–µ –∫–æ–ª–æ–Ω–∫–∏ –Ω–µ –ª–æ–º–∞–ª–∏ */
    }

    th,td{
      border-bottom:1px solid var(--line);
      padding:10px 10px;
      text-align:center;
      word-wrap:break-word;
      background:#fff;
      white-space: nowrap;
    }

    thead th{
      background:#f8fafc;
      color:#334155;
      font-weight:600;
      position: sticky;
      top: 0;
      z-index: 2;
    }

    tbody tr:hover td{ background:#f8fafc; }
    .muted{color:var(--muted);font-size:12px}

    .purchase td{ background: rgba(37,99,235,.06); }
    .sale td{ background: rgba(16,185,129,.08); }
    .transfer td{ background: rgba(245,158,11,.10); }

    /* –ë–ª–æ–∫ –≤–≤–æ–¥–∞ –∏ –∫–Ω–æ–ø–∫–∏ –≤–Ω–∏–∑—É */
    #inputBlock{
      flex: 0 0 auto;
      display:flex;
      flex-direction:column;
      gap:10px;
      margin: 0;
    }

    .formRow2{
      display:grid;
      grid-template-columns: minmax(0, 1fr) minmax(0, 1fr);
      gap:10px;
      align-items:end;
    }

    .formRow2.compact{
      grid-template-columns: minmax(0, 1fr) minmax(0, 1fr);
    }

    @media (max-width: 560px){
      .formRow2{ grid-template-columns: 1fr; }
      .formRow2.compact{ grid-template-columns: 1fr; }
      table{ min-width: 860px; }
    }

    .field{ min-width:0; }
    input,select{ min-width:0; }

    .field label{
      display:block;
      font-size:12px;
      color:var(--muted);
      margin: 0 0 6px 2px;
      text-align:left;
    }

    input,select{
      width:100%;
      padding:10px 12px;
      border-radius: 12px;
      border:1px solid var(--line);
      font-size: 14px;
      background:#fff;
      outline:none;
      transition: box-shadow .15s ease, border-color .15s ease;
    }
    input:focus, select:focus{
      border-color: rgba(37,99,235,.55);
      box-shadow: 0 0 0 4px rgba(37,99,235,.12);
    }

    .checkRow{
      display:flex;
      gap:10px;
      align-items:center;
      justify-content: space-between;
      padding: 10px 12px;
      border:1px solid var(--line);
      border-radius: 12px;
      background:#fff;
    }
    .checkRow .left{
      display:flex;
      gap:10px;
      align-items:center;
      color:#0f172a;
      font-size: 13px;
      text-align:left;
    }
    .checkRow input[type="checkbox"]{
      width: 18px;
      height: 18px;
      margin:0;
      accent-color: var(--primary);
    }
    .checkRow .hint{
      color: var(--muted);
      font-size: 12px;
      text-align:right;
      white-space: normal;
    }

    #warn{
      margin-top: 2px;
      min-height: 18px;
    }

    .btn{
      border:none;
      border-radius: 12px;
      padding: 11px 14px;
      cursor:pointer;
      font-size: 14px;
      font-weight: 600;
      transition: transform .08s ease, filter .15s ease, background .15s ease;
      box-shadow: var(--shadow2);
    }
    .btn:active{ transform: translateY(1px); }

    #addBtn{
      background: linear-gradient(180deg, var(--primary), var(--primary2));
      color:#fff;
      width:100%;
    }

    .actions{
      display:flex;
      gap:10px;
      margin-top: 6px;
      flex: 0 0 auto;
    }
    .actions .btn{flex:1}

    #resetBtn{
      background:#f1f5f9;
      color:#0f172a;
      border: 1px solid var(--line);
      box-shadow: none;
    }

    #exportBtn{
      background: linear-gradient(180deg, var(--success1), var(--success2));
      color:#fff;
    }

    .btn-del{
      width: 34px;
      height: 34px;
      border-radius: 999px;
      border: 1px solid rgba(239,68,68,.25);
      background: rgba(239,68,68,.08);
      color: var(--danger2);
      cursor:pointer;
      font-size: 16px;
      line-height: 1;
      transition: background .15s ease, transform .08s ease;
    }
    .btn-del:hover{ background: rgba(239,68,68,.14); }
    .btn-del:active{ transform: translateY(1px); }

    .tip{
      margin-top: 4px;
      color: var(--muted);
      font-size: 12px;
      text-align: center;
      flex: 0 0 auto;
    }

    .sr-only{
      position:absolute;
      width:1px;height:1px;
      padding:0;margin:-1px;
      overflow:hidden;clip:rect(0,0,0,0);
      white-space:nowrap;border:0;
    }
  </style>
</head>

<body>
  <div class="container" id="calcContainer">
    <div>
      <h2>–ö–∞–ª—å–∫—É–ª—è—Ç–æ—Ä FIFO</h2>
      <div class="subtitle">–õ—ë–≥–∫–∏–π, –ø–æ–Ω—è—Ç–Ω—ã–π, –±–µ–∑ –ª–∏—à–Ω–µ–≥–æ ‚Äî —Ä–∞–±–æ—Ç–∞–µ—Ç –ø—Ä—è–º–æ –≤ –±—Ä–∞—É–∑–µ—Ä–µ</div>
      <div class="flower-row" aria-hidden="true">üå∏ üåº üå∫ üå∑ üåª</div>
      <div class="instruction">–î–æ–±–∞–≤–ª—è–π—Ç–µ –æ–ø–µ—Ä–∞—Ü–∏–∏ –≤ —Ö—Ä–æ–Ω–æ–ª–æ–≥–∏—á–µ—Å–∫–æ–º –ø–æ—Ä—è–¥–∫–µ ‚Äî –æ—Ç –ø–µ—Ä–≤–æ–π –∫ –ø–æ—Å–ª–µ–¥—É—é—â–µ–π.</div>
    </div>

    <div class="tableWrap">
      <table id="operationsTable" aria-label="–°–ø–∏—Å–æ–∫ –æ–ø–µ—Ä–∞—Ü–∏–π">
        <thead>
          <tr>
            <th style="width:56px">‚Ññ</th>
            <th style="width:220px">–¢–∏–ø</th>
            <th style="width:90px">–ö–æ–ª-–≤–æ</th>
            <th style="width:90px">–¶–µ–Ω–∞</th>
            <th style="width:110px">–ö–æ–º–∏—Å—Å–∏—è</th>

            <th style="width:140px">–°–µ–±–µ—Å—Ç–æ–∏–º–æ—Å—Ç—å</th>
            <th style="width:140px">–°—É–º–º–∞ –ø—Ä–∏ –ø—Ä–æ–¥–∞–∂–µ</th>
            <th style="width:140px">–ü—Ä–∏–±—ã–ª—å / –£–±—ã—Ç–æ–∫</th>

            <th style="width:110px">–û—Å—Ç–∞—Ç–æ–∫ (—à—Ç)</th>
            <th style="width:170px">–ë–∞–ª–∞–Ω—Å–æ–≤–∞—è —Å—Ç–æ–∏–º–æ—Å—Ç—å –æ—Å—Ç–∞—Ç–∫–∞</th>
            <th style="width:160px">–°—Ä–µ–¥. —Å—Ç–æ–∏–º–æ—Å—Ç—å –æ—Å—Ç–∞—Ç–∫–∞</th>

            <th style="width:72px"><span class="sr-only">–î–µ–π—Å—Ç–≤–∏—è</span></th>
          </tr>
        </thead>
        <tbody>
          <tr><td colspan="12" class="muted">–ù–µ—Ç –æ–ø–µ—Ä–∞—Ü–∏–π</td></tr>
        </tbody>
      </table>
    </div>

    <div id="inputBlock">
      <div class="field" id="typeField">
        <label for="type">–¢–∏–ø –æ–ø–µ—Ä–∞—Ü–∏–∏</label>
        <select id="type">
          <option value="–ü–æ–∫—É–ø–∫–∞ (–ü—Ä–∏—Ö–æ–¥)">–ü–æ–∫—É–ø–∫–∞ (–ü—Ä–∏—Ö–æ–¥)</option>
          <option value="–ó–∞—á–∏—Å–ª–µ–Ω–∏–µ –¶–ë (–ü—Ä–∏—Ö–æ–¥)">–ó–∞—á–∏—Å–ª–µ–Ω–∏–µ –¶–ë (–ü—Ä–∏—Ö–æ–¥)</option>
          <option value="–ü—Ä–æ–¥–∞–∂–∞ (–£—Ö–æ–¥)">–ü—Ä–æ–¥–∞–∂–∞ (–£—Ö–æ–¥)</option>
          <option value="–°–ø–∏—Å–∞–Ω–∏–µ –¶–ë (–£—Ö–æ–¥)">–°–ø–∏—Å–∞–Ω–∏–µ –¶–ë (–£—Ö–æ–¥)</option>
        </select>
      </div>

      <div class="formRow2" id="row2">
        <div class="field" id="qtyField">
          <label for="qty">–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ</label>
          <input type="number" id="qty" placeholder="—Ü–µ–ª–æ–µ —á–∏—Å–ª–æ" min="1" step="1" inputmode="numeric" />
        </div>

        <div class="field" id="priceField">
          <label for="price">–¶–µ–Ω–∞</label>
          <input type="text" id="price" placeholder="—Ç–æ—á–∫–∞ –∏–ª–∏ –∑–∞–ø—è—Ç–∞—è" inputmode="decimal" />
        </div>
      </div>

      <!-- –ö–æ–º–∏—Å—Å–∏—è + –≥–∞–ª–æ—á–∫–∞ (—Ç–æ–ª—å–∫–æ –¥–ª—è –ü–æ–∫—É–ø–∫–∏) -->
      <div class="formRow2 compact" id="purchaseExtraRow" style="display:none;">
        <div class="field" id="commissionField">
          <label for="commission">–ö–æ–º–∏—Å—Å–∏–∏ –ø–æ —Å–¥–µ–ª–∫–µ</label>
          <input type="text" id="commission" placeholder="–Ω–∞–ø—Ä–∏–º–µ—Ä 100 –∏–ª–∏ 100,15" inputmode="decimal" />
        </div>

        <div class="field" id="includeCommField">
          <label>&nbsp;</label>
          <div class="checkRow">
            <div class="left">
              <input type="checkbox" id="includeCommission" />
              <span>–£—á–∏—Ç—ã–≤–∞—Ç—å –∫–æ–º–∏—Å—Å–∏—é –≤ —Å–µ–±–µ—Å—Ç–æ–∏–º–æ—Å—Ç–∏ –ø–æ–∫—É–ø–∫–∏</span>
            </div>
            <div class="hint">–ï—Å–ª–∏ –≤–∫–ª—é—á–µ–Ω–æ ‚Äî –∫–æ–º–∏—Å—Å–∏—è —Ä–∞—Å–ø—Ä–µ–¥–µ–ª—è–µ—Ç—Å—è –Ω–∞ 1 —à—Ç.</div>
          </div>
        </div>
      </div>

      <button class="btn" id="addBtn">–î–æ–±–∞–≤–∏—Ç—å –æ–ø–µ—Ä–∞—Ü–∏—é</button>
      <div id="warn" class="muted" aria-live="polite"></div>

      <div class="actions">
        <button class="btn" id="resetBtn">–û—á–∏—Å—Ç–∏—Ç—å –≤—Å—ë</button>
        <button class="btn" id="exportBtn">–í—ã–≥—Ä—É–∑–∏—Ç—å PNG</button>
      </div>

      <div class="tip">–ü–æ–¥—Å–∫–∞–∑–∫–∞: Enter –≤ –ø–æ–ª—è—Ö –¥–æ–±–∞–≤–ª—è–µ—Ç –æ–ø–µ—Ä–∞—Ü–∏—é.</div>
    </div>
  </div>

  <script src="https://html2canvas.hertzen.com/dist/html2canvas.min.js"></script>

  <script>
  (function(){
    const $ = (sel, root=document) => root.querySelector(sel);

    const round = (n, d=2) => {
      const p = 10 ** d;
      return Math.round((n + Number.EPSILON) * p) / p;
    };

    const parseNum = (v) => {
      const s = String(v ?? "").trim().replace(/\s+/g, "").replace(",", ".");
      const n = Number(s);
      return Number.isFinite(n) ? n : NaN;
    };

    const fmt2 = (n) => Number.isFinite(n) ? round(n,2).toFixed(2) : "";

    const els = {};
    const bindEls = () => {
      els.tableBody = $('#operationsTable tbody');
      els.type = $('#type');
      els.qty = $('#qty');
      els.price = $('#price');

      els.purchaseExtraRow = $('#purchaseExtraRow');
      els.commission = $('#commission');
      els.includeCommission = $('#includeCommission');

      els.priceField = $('#priceField');
      els.qtyField = $('#qtyField');

      els.add = $('#addBtn');
      els.warn = $('#warn');
      els.reset = $('#resetBtn');
      els.export = $('#exportBtn');

      els.container = $('#calcContainer');
      els.table = $('#operationsTable');
    };

    const state = {
      ops: [],
      lots: [] // {qty, price} where price = effective unit cost (with/without commission)
    };

    const setWarn = (msg='') => { if (els.warn) els.warn.textContent = msg; };

    const isIncomeType = (type) =>
      type === '–ü–æ–∫—É–ø–∫–∞ (–ü—Ä–∏—Ö–æ–¥)' || type === '–ó–∞—á–∏—Å–ª–µ–Ω–∏–µ –¶–ë (–ü—Ä–∏—Ö–æ–¥)';
    const isSaleType = (type) => type === '–ü—Ä–æ–¥–∞–∂–∞ (–£—Ö–æ–¥)';
    const isWriteOffType = (type) => type === '–°–ø–∏—Å–∞–Ω–∏–µ –¶–ë (–£—Ö–æ–¥)';

    const calcRemainSnapshot = () => {
      let q = 0, v = 0;
      for (const lot of state.lots) {
        if (lot.qty > 0) {
          q += lot.qty;
          v += lot.qty * lot.price;
        }
      }
      return {
        qty: q,
        value: round(v, 2),
        avg: q ? round(v / q, 2) : 0
      };
    };

    const renderRows = () => {
      if (!els.tableBody) return;

      const body = els.tableBody;
      body.innerHTML = state.ops.length ? '' : '<tr><td colspan="12" class="muted">–ù–µ—Ç –æ–ø–µ—Ä–∞—Ü–∏–π</td></tr>';

      if (!state.ops.length) return;

      const frag = document.createDocumentFragment();

      state.ops.forEach((op, i) => {
        const tr = document.createElement('tr');
        tr.className = isIncomeType(op.type) ? 'purchase' : (isSaleType(op.type) ? 'sale' : 'transfer');

        const priceCell = isWriteOffType(op.type) ? '-' : fmt2(op.price);
        const commCell = (op.type === '–ü–æ–∫—É–ø–∫–∞ (–ü—Ä–∏—Ö–æ–¥)') ? fmt2(op.commission || 0) : '-';

        const costCell = Number.isFinite(op.cost) ? fmt2(op.cost) : '';
        const revenueCell = Number.isFinite(op.revenue) ? fmt2(op.revenue) : '';
        const pnlCell = Number.isFinite(op.pnl) ? fmt2(op.pnl) : '';

        const remainCell = Number.isFinite(op.remain) ? String(op.remain) : '';
        const balCell = Number.isFinite(op.balanceCost) ? fmt2(op.balanceCost) : '';
        const avgCell = Number.isFinite(op.avgRemain) ? fmt2(op.avgRemain) : '';

        tr.innerHTML = `
          <td>${i+1}</td>
          <td>${op.type}</td>
          <td>${op.qty}</td>
          <td>${priceCell}</td>
          <td>${commCell}</td>

          <td>${costCell}</td>
          <td>${revenueCell}</td>
          <td>${pnlCell}</td>

          <td>${remainCell}</td>
          <td>${balCell}</td>
          <td>${avgCell}</td>

          <td><button class="btn-del" data-i="${i}" title="–£–¥–∞–ª–∏—Ç—å">√ó</button></td>
        `;
        frag.appendChild(tr);
      });

      body.appendChild(frag);
    };

    const getAvailable = () => {
      let available = 0;
      for (const op of state.ops) {
        if (isIncomeType(op.type)) available += op.qty;
        else available -= op.qty; // –ø—Ä–æ–¥–∞–∂–∞/—Å–ø–∏—Å–∞–Ω–∏–µ —Ö—Ä–∞–Ω–∏–º –∫–∞–∫ qty > 0
      }
      return available;
    };

    const compute = () => {
      state.lots = [];

      for (let idx = 0; idx < state.ops.length; idx++) {
        const op = state.ops[idx];

        // —Å–±—Ä–æ—Å
        op.cost = NaN;
        op.revenue = NaN;
        op.pnl = NaN;
        op.remain = NaN;
        op.balanceCost = NaN;
        op.avgRemain = NaN;

        if (isIncomeType(op.type)) {
          // effective unit cost
          let lotPrice = op.price;

          // –∫–æ–º–∏—Å—Å–∏—è —É—á–∏—Ç—ã–≤–∞–µ—Ç—Å—è —Ç–æ–ª—å–∫–æ –¥–ª—è "–ü–æ–∫—É–ø–∫–∞" –∏ —Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ –≥–∞–ª–æ—á–∫–∞ –≤–∫–ª—é—á–µ–Ω–∞
          if (op.type === '–ü–æ–∫—É–ø–∫–∞ (–ü—Ä–∏—Ö–æ–¥)' && op.includeCommission) {
            const c = Number.isFinite(op.commission) ? op.commission : 0;
            lotPrice = (op.qty * op.price + c) / op.qty;
          }

          state.lots.push({ qty: op.qty, price: lotPrice });

          // —Å–µ–±–µ—Å—Ç–æ–∏–º–æ—Å—Ç—å –ø—Ä–∏—Ö–æ–¥–∞ (–ø–æ —Ñ–∞–∫—Ç—É)
          op.cost = round(op.qty * lotPrice, 2);

        } else if (isSaleType(op.type)) {
          // –ø—Ä–æ–¥–∞–∂–∞: FIFO cost
          let need = op.qty;
          let fifoCost = 0;

          while (need > 0 && state.lots.length) {
            const lot = state.lots[0];
            const used = Math.min(need, lot.qty);

            if (used > 0) {
              fifoCost += used * lot.price;
              lot.qty -= used;
              need -= used;
            }
            if (lot.qty === 0) state.lots.shift();
          }

          op.cost = round(fifoCost, 2);
          op.revenue = round(op.qty * op.price, 2);
          op.pnl = round(op.revenue - op.cost, 2);

        } else if (isWriteOffType(op.type)) {
          // —Å–ø–∏—Å–∞–Ω–∏–µ: FIFO cost, –±–µ–∑ –≤—ã—Ä—É—á–∫–∏/–ø—Ä–∏–±.
          let need = op.qty;
          let fifoCost = 0;

          while (need > 0 && state.lots.length) {
            const lot = state.lots[0];
            const used = Math.min(need, lot.qty);

            if (used > 0) {
              fifoCost += used * lot.price;
              lot.qty -= used;
              need -= used;
            }
            if (lot.qty === 0) state.lots.shift();
          }

          op.cost = round(fifoCost, 2);
        }

        const snap = calcRemainSnapshot();
        op.remain = snap.qty;
        op.balanceCost = snap.value;
        op.avgRemain = snap.avg;
      }

      renderRows();
    };

    const onTypeChange = () => {
      const type = els.type.value;

      // –¶–µ–Ω–∞ —Å–∫—Ä—ã–≤–∞–µ—Ç—Å—è —Ç–æ–ª—å–∫–æ –¥–ª—è "–°–ø–∏—Å–∞–Ω–∏–µ"
      const hidePrice = isWriteOffType(type);
      els.priceField.style.display = hidePrice ? 'none' : 'block';
      els.price.disabled = hidePrice;
      if (hidePrice) els.price.value = '';

      // –ö–æ–º–∏—Å—Å–∏—è + –≥–∞–ª–æ—á–∫–∞ –ø–æ–∫–∞–∑—ã–≤–∞—é—Ç—Å—è —Ç–æ–ª—å–∫–æ –¥–ª—è "–ü–æ–∫—É–ø–∫–∞ (–ü—Ä–∏—Ö–æ–¥)"
      const showPurchaseExtra = (type === '–ü–æ–∫—É–ø–∫–∞ (–ü—Ä–∏—Ö–æ–¥)');
      els.purchaseExtraRow.style.display = showPurchaseExtra ? 'grid' : 'none';
      if (!showPurchaseExtra) {
        els.commission.value = '';
        els.includeCommission.checked = false;
      }
    };

    const addOperation = () => {
      const type = els.type.value;

      const qty = parseNum(els.qty.value);
      const price = parseNum(els.price.value);

      // –∫–æ–º–∏—Å—Å–∏—è —Ç–æ–ª—å–∫–æ –¥–ª—è –ø–æ–∫—É–ø–∫–∏
      const commission = parseNum(els.commission.value);
      const includeCommission = !!els.includeCommission.checked;

      if (!Number.isFinite(qty) || qty <= 0 || !Number.isInteger(qty)) {
        return setWarn('–í–≤–µ–¥–∏—Ç–µ –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ (—Ü–µ–ª–æ–µ —á–∏—Å–ª–æ > 0).');
      }

      if (!isWriteOffType(type)) {
        if (!Number.isFinite(price) || price <= 0) {
          return setWarn('–í–≤–µ–¥–∏—Ç–µ –∫–æ—Ä—Ä–µ–∫—Ç–Ω—É—é —Ü–µ–Ω—É (> 0). –ú–æ–∂–Ω–æ —Å –∑–∞–ø—è—Ç–æ–π.');
        }
      }

      if (type === '–ü–æ–∫—É–ø–∫–∞ (–ü—Ä–∏—Ö–æ–¥)') {
        // –µ—Å–ª–∏ –∫–æ–º–∏—Å—Å–∏—è –ø—É—Å—Ç–∞—è ‚Äî —Å—á–∏—Ç–∞–µ–º 0
        if (els.commission.value.trim() !== '' && (!Number.isFinite(commission) || commission < 0)) {
          return setWarn('–ö–æ–º–∏—Å—Å–∏—è –¥–æ–ª–∂–Ω–∞ –±—ã—Ç—å —á–∏—Å–ª–æ–º (>= 0). –ú–æ–∂–Ω–æ —Å –∑–∞–ø—è—Ç–æ–π.');
        }
      }

      // –∫–æ–Ω—Ç—Ä–æ–ª—å –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç–∏
      const currentAvail = getAvailable();
      const availAfter = isIncomeType(type) ? (currentAvail + qty) : (currentAvail - qty);
      if (availAfter < 0) {
        const verb = isWriteOffType(type) ? '—Å–ø–∏—Å–∞—Ç—å' : '–ø—Ä–æ–¥–∞—Ç—å';
        return setWarn(`–ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –±—É–º–∞–≥: –¥–æ—Å—Ç—É–ø–Ω–æ ${currentAvail} —à—Ç., –ø—ã—Ç–∞–µ—Ç–µ—Å—å ${verb} ${qty} —à—Ç.`);
      }

      setWarn('');

      state.ops.push({
        type,
        qty: Math.trunc(qty),
        price: isWriteOffType(type) ? NaN : price,

        commission: (type === '–ü–æ–∫—É–ø–∫–∞ (–ü—Ä–∏—Ö–æ–¥)') ? (Number.isFinite(commission) ? commission : 0) : NaN,
        includeCommission: (type === '–ü–æ–∫—É–ø–∫–∞ (–ü—Ä–∏—Ö–æ–¥)') ? includeCommission : false,

        cost: NaN,
        revenue: NaN,
        pnl: NaN,
        remain: NaN,
        balanceCost: NaN,
        avgRemain: NaN
      });

      compute();

      // –æ—á–∏—Å—Ç–∫–∞ –ø–æ–ª–µ–π
      els.qty.value = '';
      els.price.value = '';
      els.commission.value = '';
      els.qty.focus();
    };

    const onTableClick = (e) => {
      const btn = e.target.closest('.btn-del');
      if (!btn) return;
      const i = Number(btn.dataset.i);
      if (Number.isNaN(i)) return;

      state.ops.splice(i, 1);
      compute();
    };

    const resetAll = () => {
      state.ops.length = 0;
      state.lots.length = 0;

      setWarn('');
      renderRows();

      els.qty.value = '';
      els.price.value = '';
      els.commission.value = '';
      els.includeCommission.checked = false;

      els.qty.focus();
    };

    const exportPng = async () => {
      if (!els.container) return;

      if (typeof html2canvas !== 'function') {
        setWarn('–≠–∫—Å–ø–æ—Ä—Ç –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω: –±–∏–±–ª–∏–æ—Ç–µ–∫–∞ html2canvas –Ω–µ –∑–∞–≥—Ä—É–∂–µ–Ω–∞.');
        return;
      }

      const prev = els.export.textContent;
      els.export.textContent = '–ì–æ—Ç–æ–≤–ª—é‚Ä¶';
      els.export.disabled = true;
      setWarn('');

      try {
        const canvas = await html2canvas(els.container, {
          backgroundColor: null,
          scale: Math.min(2, window.devicePixelRatio || 1)
        });

        const a = document.createElement('a');
        a.download = 'fifo_result.png';
        a.href = canvas.toDataURL('image/png');
        a.click();
      } catch (err) {
        console.error(err);
        setWarn('–ù–µ —É–¥–∞–ª–æ—Å—å –≤—ã–≥—Ä—É–∑–∏—Ç—å PNG. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –µ—â—ë —Ä–∞–∑.');
      } finally {
        els.export.textContent = prev;
        els.export.disabled = false;
      }
    };

    const onKeyDown = (e) => {
      if (e.key === 'Enter') {
        e.preventDefault();
        addOperation();
      }
    };

    document.addEventListener('DOMContentLoaded', () => {
      bindEls();

      els.type.addEventListener('change', onTypeChange);
      els.add.addEventListener('click', addOperation);
      els.table.addEventListener('click', onTableClick);
      els.reset.addEventListener('click', resetAll);
      els.export.addEventListener('click', exportPng);

      els.qty.addEventListener('keydown', onKeyDown);
      els.price.addEventListener('keydown', onKeyDown);
      els.commission.addEventListener('keydown', onKeyDown);
      els.type.addEventListener('keydown', onKeyDown);

      onTypeChange();
      renderRows();
    });
  })();
  </script>
</body>
</html>
