<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>–ö–∞–ª—å–∫—É–ª—è—Ç–æ—Ä FIFO ‚Äî —Å—Ç–∏–ª—å–Ω–∞—è –≤–µ—Ä—Å–∏—è</title>

  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">

  <style>
    /* ‚úÖ —á—Ç–æ–±—ã input/select –Ω–µ "–≤—ã–ø–∏—Ä–∞–ª–∏" –∏ –Ω–µ –Ω–∞–µ–∑–∂–∞–ª–∏ */
    *, *::before, *::after { box-sizing: border-box; }

    :root{
      --bg:#f6f8fb;
      --card:#ffffff;
      --ink:#0f172a;
      --muted:#64748b;
      --line:#e5e7eb;

      --primary:#2563eb;
      --primary2:#1d4ed8;

      --info1:#0ea5e9;
      --info2:#0284c7;

      --success1:#10b981;
      --success2:#059669;

      --danger:#ef4444;
      --danger2:#dc2626;

      --shadow: 0 12px 30px rgba(2, 8, 23, .08);
      --shadow2: 0 2px 10px rgba(2, 8, 23, .06);

      --r12:12px;
      --r16:16px;
    }

    html,body{height:100%}
    body{
      margin:0;
      font-family: Inter, system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
      color:var(--ink);
      background:
        radial-gradient(1200px 600px at 10% -10%, rgba(37,99,235,.10), transparent 60%),
        radial-gradient(900px 600px at 100% 0%, rgba(16,185,129,.10), transparent 55%),
        var(--bg);
    }

    .container{
      max-width: 980px;
      margin: 28px auto;
      padding: 22px;
      background: var(--card);
      border: 1px solid var(--line);
      border-radius: var(--r16);
      box-shadow: var(--shadow);
    }

    h2{
      margin: 4px 0 6px;
      font-size: 22px;
      letter-spacing: -0.02em;
      text-align:center;
    }

    .subtitle{
      text-align:center;
      color:var(--muted);
      font-size: 13px;
      margin-bottom: 14px;
    }

    .instruction{
      display:flex;
      gap:10px;
      align-items:flex-start;
      background: #fff7ed;
      border:1px solid #fed7aa;
      color:#7c2d12;
      border-radius: var(--r12);
      padding: 12px 12px;
      font-size: 13px;
      line-height: 1.4;
      margin-bottom: 14px;
    }
    .instruction:before{
      content:"üí°";
      font-size: 16px;
      line-height: 1.2;
      margin-top: 1px;
    }

    table{
      width:100%;
      border-collapse:separate;
      border-spacing:0;
      font-size: 13px;
      margin-bottom: 12px;
      table-layout:fixed;
      overflow:hidden;
      border:1px solid var(--line);
      border-radius: var(--r12);
      box-shadow: var(--shadow2);
    }

    th,td{
      border-bottom:1px solid var(--line);
      padding:10px 10px;
      text-align:center;
      word-wrap:break-word;
      background:#fff;
    }

    thead th{
      background:#f8fafc;
      color:#334155;
      font-weight:600;
    }

    tbody tr:hover td{
      background:#f8fafc;
    }

    th:first-child, td:first-child{width:56px}
    th:last-child, td:last-child{width:72px}

    .muted{color:var(--muted);font-size:12px}

    .purchase td{ background: rgba(37,99,235,.06); }
    .sale td{ background: rgba(16,185,129,.08); }
    .transfer td{ background: rgba(245,158,11,.10); }

    .info-line{
      text-align:left;
      font-size: 12.5px;
      color:#0f172a;
      padding-left: 12px;
      font-style: normal;
      opacity:.9;
      background:#fff;
    }

    /* ‚úÖ –Ω–æ–≤–∞—è —Å—Ç—Ä—É–∫—Ç—É—Ä–∞ —Ñ–æ—Ä–º—ã –±–µ–∑ –æ–±—â–µ–≥–æ grid (—Å–∞–º—ã–π —Å—Ç–∞–±–∏–ª—å–Ω—ã–π –≤–∞—Ä–∏–∞–Ω—Ç) */
    #inputBlock{
      margin-top: 12px;
      display:flex;
      flex-direction:column;
      gap:10px;
    }

    .formRow2{
      display:grid;
      grid-template-columns: minmax(0, 1fr) minmax(0, 1fr);
      gap:10px;
      align-items:end;
    }

    @media (max-width: 560px){
      .formRow2{ grid-template-columns: 1fr; }
    }

    .field{ min-width:0; }
    input,select{ min-width:0; }

    .field label{
      display:block;
      font-size:12px;
      color:var(--muted);
      margin: 0 0 6px 2px;
      text-align:left;
    }

    input,select{
      width:100%;
      padding:10px 12px;
      border-radius: 12px;
      border:1px solid var(--line);
      font-size: 14px;
      background:#fff;
      outline:none;
      transition: box-shadow .15s ease, border-color .15s ease;
    }
    input:focus, select:focus{
      border-color: rgba(37,99,235,.55);
      box-shadow: 0 0 0 4px rgba(37,99,235,.12);
    }

    #warn{
      margin-top: 2px;
      min-height: 18px;
    }

    .btn{
      border:none;
      border-radius: 12px;
      padding: 11px 14px;
      cursor:pointer;
      font-size: 14px;
      font-weight: 600;
      transition: transform .08s ease, filter .15s ease, background .15s ease;
      box-shadow: var(--shadow2);
    }
    .btn:active{ transform: translateY(1px); }

    #addBtn{
      background: linear-gradient(180deg, var(--primary), var(--primary2));
      color:#fff;
      width:100%;
    }

    #toggleResultsBtn{
      background: linear-gradient(180deg, var(--info1), var(--info2));
      color:#fff;
      width:100%;
      margin-top: 10px;
    }

    .actions{
      display:flex;
      gap:10px;
      margin-top: 10px;
    }
    .actions .btn{flex:1}

    #resetBtn{
      background:#f1f5f9;
      color:#0f172a;
      border: 1px solid var(--line);
      box-shadow: none;
    }

    #exportBtn{
      background: linear-gradient(180deg, var(--success1), var(--success2));
      color:#fff;
    }

    .btn-del{
      width: 34px;
      height: 34px;
      border-radius: 999px;
      border: 1px solid rgba(239,68,68,.25);
      background: rgba(239,68,68,.08);
      color: var(--danger2);
      cursor:pointer;
      font-size: 16px;
      line-height: 1;
      transition: background .15s ease, transform .08s ease;
    }
    .btn-del:hover{ background: rgba(239,68,68,.14); }
    .btn-del:active{ transform: translateY(1px); }

    #resultsBox{
      display:none;
      background:#0b1220;
      color:#e5e7eb;
      border:1px solid rgba(148,163,184,.25);
      border-radius: var(--r12);
      padding: 12px 12px;
      margin-top: 12px;
      font-size: 13px;
      white-space: pre-line;
      line-height: 1.6;
      box-shadow: var(--shadow2);
    }

    .tip{
      margin-top: 10px;
      color: var(--muted);
      font-size: 12px;
      text-align: center;
    }

    .sr-only{
      position:absolute;
      width:1px;height:1px;
      padding:0;margin:-1px;
      overflow:hidden;clip:rect(0,0,0,0);
      white-space:nowrap;border:0;
    }
  </style>
</head>

<body>
  <div class="container" id="calcContainer">
    <h2>–ö–∞–ª—å–∫—É–ª—è—Ç–æ—Ä FIFO</h2>
    <div class="subtitle">–õ—ë–≥–∫–∏–π, –ø–æ–Ω—è—Ç–Ω—ã–π, –±–µ–∑ –ª–∏—à–Ω–µ–≥–æ ‚Äî —Ä–∞–±–æ—Ç–∞–µ—Ç –ø—Ä—è–º–æ –≤ –±—Ä–∞—É–∑–µ—Ä–µ</div>

    <div class="instruction">–î–æ–±–∞–≤–ª—è–π—Ç–µ –æ–ø–µ—Ä–∞—Ü–∏–∏ –≤ —Ö—Ä–æ–Ω–æ–ª–æ–≥–∏—á–µ—Å–∫–æ–º –ø–æ—Ä—è–¥–∫–µ ‚Äî –æ—Ç –ø–µ—Ä–≤–æ–π –∫ –ø–æ—Å–ª–µ–¥—É—é—â–µ–π.</div>

    <table id="operationsTable" aria-label="–°–ø–∏—Å–æ–∫ –æ–ø–µ—Ä–∞—Ü–∏–π">
      <thead>
        <tr>
          <th>‚Ññ</th>
          <th>–¢–∏–ø</th>
          <th>–ö–æ–ª-–≤–æ</th>
          <th>–¶–µ–Ω–∞</th>
          <th><span class="sr-only">–î–µ–π—Å—Ç–≤–∏—è</span></th>
        </tr>
      </thead>
      <tbody>
        <tr><td colspan="5" class="muted">–ù–µ—Ç –æ–ø–µ—Ä–∞—Ü–∏–π</td></tr>
      </tbody>
    </table>

    <div id="inputBlock">
      <div class="field" id="typeField">
        <label for="type">–¢–∏–ø –æ–ø–µ—Ä–∞—Ü–∏–∏</label>
        <select id="type">
          <option value="–ü–æ–∫—É–ø–∫–∞ (–ü—Ä–∏—Ö–æ–¥)">–ü–æ–∫—É–ø–∫–∞ (–ü—Ä–∏—Ö–æ–¥)</option>
          <option value="–ü—Ä–æ–¥–∞–∂–∞ (–£—Ö–æ–¥)">–ü—Ä–æ–¥–∞–∂–∞ (–£—Ö–æ–¥)</option>
          <option value="–°–ø–∏—Å–∞–Ω–∏–µ –¶–ë (–£—Ö–æ–¥)">–°–ø–∏—Å–∞–Ω–∏–µ –¶–ë (–£—Ö–æ–¥)</option>
        </select>
      </div>

      <div class="formRow2" id="row2">
        <div class="field" id="qtyField">
          <label for="qty">–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ</label>
          <input type="number" id="qty" placeholder="—Ü–µ–ª–æ–µ —á–∏—Å–ª–æ" min="1" step="1" inputmode="numeric" />
        </div>

        <div class="field" id="priceField">
          <label for="price">–¶–µ–Ω–∞</label>
          <input type="text" id="price" placeholder="—Ç–æ—á–∫–∞ –∏–ª–∏ –∑–∞–ø—è—Ç–∞—è" inputmode="decimal" />
        </div>
      </div>

      <button class="btn" id="addBtn">–î–æ–±–∞–≤–∏—Ç—å –æ–ø–µ—Ä–∞—Ü–∏—é</button>
      <div id="warn" class="muted" aria-live="polite"></div>
    </div>

    <button class="btn" id="toggleResultsBtn">–ü–æ–∫–∞–∑–∞—Ç—å —Ä–∞—Å—á—ë—Ç—ã</button>
    <div id="resultsBox"></div>

    <div class="actions">
      <button class="btn" id="resetBtn">–û—á–∏—Å—Ç–∏—Ç—å –≤—Å—ë</button>
      <button class="btn" id="exportBtn">–í—ã–≥—Ä—É–∑–∏—Ç—å PNG</button>
    </div>

    <div class="tip">–ü–æ–¥—Å–∫–∞–∑–∫–∞: Enter –≤ –ø–æ–ª—è—Ö –¥–æ–±–∞–≤–ª—è–µ—Ç –æ–ø–µ—Ä–∞—Ü–∏—é.</div>
  </div>

  <script src="https://html2canvas.hertzen.com/dist/html2canvas.min.js"></script>

  <script>
  (function(){
    const $ = (sel, root=document) => root.querySelector(sel);

    const round = (n, d=2) => {
      const p = 10 ** d;
      return Math.round((n + Number.EPSILON) * p) / p;
    };

    const parseNum = (v) => {
      const s = String(v ?? "").trim().replace(/\s+/g, "").replace(",", ".");
      const n = Number(s);
      return Number.isFinite(n) ? n : NaN;
    };

    const fmt2 = (n) => Number.isFinite(n) ? round(n,2).toFixed(2) : "-";

    const els = {};
    const bindEls = () => {
      els.tableBody = $('#operationsTable tbody');
      els.type = $('#type');
      els.qty = $('#qty');
      els.price = $('#price');
      els.priceField = $('#priceField');
      els.qtyField = $('#qtyField');
      els.add = $('#addBtn');
      els.warn = $('#warn');
      els.toggleResults = $('#toggleResultsBtn');
      els.results = $('#resultsBox');
      els.reset = $('#resetBtn');
      els.export = $('#exportBtn');
      els.container = $('#calcContainer');
      els.table = $('#operationsTable');
    };

    const state = {
      ops: [],
      lots: [],
      details: [],
      totalQty: 0,
      avgPrice: 0
    };

    const setWarn = (msg='') => { if (els.warn) els.warn.textContent = msg; };

    const recalcTotals = () => {
      let q = 0, v = 0;
      for (const lot of state.lots) {
        if (lot.qty > 0) {
          q += lot.qty;
          v += lot.qty * lot.price;
        }
      }
      state.totalQty = q;
      state.avgPrice = q ? round(v / q, 2) : 0;
    };

    const renderRows = () => {
      if (!els.tableBody) return;

      const body = els.tableBody;
      body.innerHTML = state.ops.length ? '' : '<tr><td colspan="5" class="muted">–ù–µ—Ç –æ–ø–µ—Ä–∞—Ü–∏–π</td></tr>';

      const frag = document.createDocumentFragment();

      state.ops.forEach((op, i) => {
        const tr = document.createElement('tr');
        tr.className =
          op.type.includes('–ü–æ–∫—É–ø–∫–∞') ? 'purchase' :
          op.type.includes('–ü—Ä–æ–¥–∞–∂–∞') ? 'sale' : 'transfer';

        const priceCell = (op.type === '–°–ø–∏—Å–∞–Ω–∏–µ –¶–ë (–£—Ö–æ–¥)') ? '-' : fmt2(op.price);

        tr.innerHTML = `
          <td>${i+1}</td>
          <td>${op.type}</td>
          <td>${op.qty}</td>
          <td>${priceCell}</td>
          <td><button class="btn-del" data-i="${i}" title="–£–¥–∞–ª–∏—Ç—å">√ó</button></td>
        `;
        frag.appendChild(tr);

        const info = document.createElement('tr');
        const avgRemain = fmt2(op.avgRemain);

        if (op.type === '–°–ø–∏—Å–∞–Ω–∏–µ –¶–ë (–£—Ö–æ–¥)') {
          info.innerHTML = `
            <td colspan="5" class="info-line">
              üìå –°–ø–∏—Å–∞–Ω–æ: <b>${op.qty}</b> —à—Ç. (—Å—Ä–µ–¥–Ω—è—è —Ü–µ–Ω–∞ —Å–ø–∏—Å–∞–Ω–∏—è: <b>${fmt2(op.avgWriteOff)}</b>)<br>
              üìä –û—Å—Ç–∞—Ç–æ–∫: <b>${op.remain}</b> —à—Ç. (—Å—Ä–µ–¥–Ω—è—è —Ü–µ–Ω–∞ –æ—Å—Ç–∞—Ç–∫–∞: <b>${avgRemain}</b>)
            </td>
          `;
        } else {
          info.innerHTML = `
            <td colspan="5" class="info-line">
              üìä –û—Å—Ç–∞—Ç–æ–∫: <b>${op.remain}</b> —à—Ç. (—Å—Ä–µ–¥–Ω—è—è —Ü–µ–Ω–∞ –æ—Å—Ç–∞—Ç–∫–∞: <b>${avgRemain}</b>)
            </td>
          `;
        }

        frag.appendChild(info);
      });

      body.appendChild(frag);
    };

    const getAvailable = () => {
      let available = 0;
      for (const op of state.ops) {
        if (op.type === '–ü–æ–∫—É–ø–∫–∞ (–ü—Ä–∏—Ö–æ–¥)') available += op.qty;
        else available -= op.qty;
      }
      return available;
    };

    const compute = () => {
      state.lots = [];
      state.details = [];

      for (let idx = 0; idx < state.ops.length; idx++) {
        const op = state.ops[idx];
        const num = idx + 1;

        let detail = `${num} ‚Äî –û–ø–µ—Ä–∞—Ü–∏—è: ${op.type}`;
        let lotDetails = '';

        if (op.type === '–ü–æ–∫—É–ø–∫–∞ (–ü—Ä–∏—Ö–æ–¥)') {
          state.lots.push({ qty: op.qty, price: op.price });
          lotDetails += `: ${op.qty} —à—Ç. –ø–æ —Ü–µ–Ω–µ ${fmt2(op.price)}.`;

        } else if (op.type === '–ü—Ä–æ–¥–∞–∂–∞ (–£—Ö–æ–¥)') {
          let remain = op.qty;
          const soldFrom = [];

          while (remain > 0 && state.lots.length) {
            const lot = state.lots[0];
            const used = Math.min(remain, lot.qty);

            if (used > 0) {
              soldFrom.push(` - –ü—Ä–æ–¥–∞–Ω–æ ${used} —à—Ç. –ø–æ —Ü–µ–Ω–µ ${fmt2(lot.price)}.`);
              lot.qty -= used;
              remain -= used;
            }

            if (lot.qty === 0) state.lots.shift();
          }

          lotDetails += `: ${op.qty} —à—Ç.\n${soldFrom.join('\n')}`;

        } else if (op.type === '–°–ø–∏—Å–∞–Ω–∏–µ –¶–ë (–£—Ö–æ–¥)') {
          let remain = op.qty;
          let total = 0;
          let used = 0;
          const writeOffInfo = [];

          while (remain > 0 && state.lots.length) {
            const lot = state.lots[0];
            const take = Math.min(remain, lot.qty);

            if (take > 0) {
              writeOffInfo.push(` - –°–ø–∏—Å–∞–Ω–æ ${take} —à—Ç. –ø–æ ${fmt2(lot.price)}.`);
              total += take * lot.price;
              used += take;
              lot.qty -= take;
              remain -= take;
            }

            if (lot.qty === 0) state.lots.shift();
          }

          op.avgWriteOff = used ? round(total / used, 2) : 0;
          lotDetails += `: ${op.qty} —à—Ç.\n${writeOffInfo.join('\n')}\n - –°—Ä–µ–¥–Ω—è—è —Ü–µ–Ω–∞ —Å–ø–∏—Å–∞–Ω–∏—è: ${fmt2(op.avgWriteOff)}.`;
        }

        recalcTotals();
        op.remain = state.totalQty;
        op.avgRemain = state.avgPrice;

        detail += lotDetails + `\n - –û—Å—Ç–∞—Ç–æ–∫: ${op.remain} —à—Ç., —Å—Ä–µ–¥–Ω—è—è —Ü–µ–Ω–∞ –æ—Å—Ç–∞—Ç–∫–∞: ${fmt2(op.avgRemain)}.`;
        state.details.push(detail);
      }

      renderRows();

      if (els.results && els.results.style.display === 'block') {
        els.results.textContent = state.details.length ? state.details.join('\n\n') : '–ù–µ—Ç —Ä–∞—Å—á—ë—Ç–æ–≤';
      }
    };

    const onTypeChange = () => {
      const isWriteOff = els.type.value === '–°–ø–∏—Å–∞–Ω–∏–µ –¶–ë (–£—Ö–æ–¥)';

      els.priceField.style.display = isWriteOff ? 'none' : 'block';
      els.price.disabled = isWriteOff;
      if (isWriteOff) els.price.value = '';

      /* ‚úÖ –∫–æ–≥–¥–∞ —Ü–µ–Ω–∞ —Å–∫—Ä—ã—Ç–∞ ‚Äî –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –∑–∞–Ω–∏–º–∞–µ—Ç –≤—Å—é —Å—Ç—Ä–æ–∫—É */
      if (els.qtyField) {
        els.qtyField.style.gridColumn = isWriteOff ? '1 / -1' : '';
      }
    };

    const addOperation = () => {
      const type = els.type.value;

      const qty = parseNum(els.qty.value);
      const price = parseNum(els.price.value);

      if (!Number.isFinite(qty) || qty <= 0 || !Number.isInteger(qty)) {
        return setWarn('–í–≤–µ–¥–∏—Ç–µ –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ (—Ü–µ–ª–æ–µ —á–∏—Å–ª–æ > 0).');
      }

      if (type !== '–°–ø–∏—Å–∞–Ω–∏–µ –¶–ë (–£—Ö–æ–¥)') {
        if (!Number.isFinite(price) || price <= 0) {
          return setWarn('–í–≤–µ–¥–∏—Ç–µ –∫–æ—Ä—Ä–µ–∫—Ç–Ω—É—é —Ü–µ–Ω—É (> 0). –ú–æ–∂–Ω–æ —Å –∑–∞–ø—è—Ç–æ–π.');
        }
      }

      const currentAvail = getAvailable();
      const availAfter = (type === '–ü–æ–∫—É–ø–∫–∞ (–ü—Ä–∏—Ö–æ–¥)') ? (currentAvail + qty) : (currentAvail - qty);

      if (availAfter < 0) {
        const verb = type.includes('–°–ø–∏—Å–∞–Ω–∏–µ') ? '—Å–ø–∏—Å–∞—Ç—å' : '–ø—Ä–æ–¥–∞—Ç—å';
        return setWarn(`–ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –±—É–º–∞–≥: –¥–æ—Å—Ç—É–ø–Ω–æ ${currentAvail} —à—Ç., –ø—ã—Ç–∞–µ—Ç–µ—Å—å ${verb} ${qty} —à—Ç.`);
      }

      setWarn('');

      state.ops.push({
        type,
        qty: Math.trunc(qty),
        price: (type === '–°–ø–∏—Å–∞–Ω–∏–µ –¶–ë (–£—Ö–æ–¥)') ? null : price,
        avgWriteOff: 0,
        remain: 0,
        avgRemain: 0
      });

      compute();

      els.qty.value = '';
      els.price.value = '';
      els.qty.focus();
    };

    const onTableClick = (e) => {
      const btn = e.target.closest('.btn-del');
      if (!btn) return;
      const i = Number(btn.dataset.i);
      if (Number.isNaN(i)) return;

      state.ops.splice(i, 1);
      compute();
    };

    const toggleResults = () => {
      if (!els.results) return;

      const isOpen = els.results.style.display === 'block';
      if (isOpen) {
        els.results.style.display = 'none';
        els.toggleResults.textContent = '–ü–æ–∫–∞–∑–∞—Ç—å —Ä–∞—Å—á—ë—Ç—ã';
        return;
      }

      els.results.style.display = 'block';
      els.results.textContent = state.details.length ? state.details.join('\n\n') : '–ù–µ—Ç —Ä–∞—Å—á—ë—Ç–æ–≤';
      els.toggleResults.textContent = '–°–∫—Ä—ã—Ç—å —Ä–∞—Å—á—ë—Ç—ã';
    };

    const resetAll = () => {
      state.ops.length = 0;
      state.lots.length = 0;
      state.details.length = 0;
      state.totalQty = 0;
      state.avgPrice = 0;

      setWarn('');
      if (els.results) {
        els.results.textContent = '';
        els.results.style.display = 'none';
      }
      if (els.toggleResults) els.toggleResults.textContent = '–ü–æ–∫–∞–∑–∞—Ç—å —Ä–∞—Å—á—ë—Ç—ã';

      renderRows();
      els.qty.value = '';
      els.price.value = '';
      els.qty.focus();
    };

    const exportPng = async () => {
      if (!els.container) return;

      const prev = els.export.textContent;
      els.export.textContent = '–ì–æ—Ç–æ–≤–ª—é‚Ä¶';
      els.export.disabled = true;
      setWarn('');

      try {
        const canvas = await html2canvas(els.container, {
          backgroundColor: null,
          scale: Math.min(2, window.devicePixelRatio || 1)
        });

        const a = document.createElement('a');
        a.download = 'fifo_result.png';
        a.href = canvas.toDataURL('image/png');
        a.click();
      } catch (err) {
        console.error(err);
        setWarn('–ù–µ —É–¥–∞–ª–æ—Å—å –≤—ã–≥—Ä—É–∑–∏—Ç—å PNG. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –µ—â—ë —Ä–∞–∑.');
      } finally {
        els.export.textContent = prev;
        els.export.disabled = false;
      }
    };

    const onKeyDown = (e) => {
      if (e.key === 'Enter') {
        e.preventDefault();
        addOperation();
      }
    };

    document.addEventListener('DOMContentLoaded', () => {
      bindEls();

      els.type.addEventListener('change', onTypeChange);
      els.add.addEventListener('click', addOperation);
      els.table.addEventListener('click', onTableClick);
      els.toggleResults.addEventListener('click', toggleResults);
      els.reset.addEventListener('click', resetAll);
      els.export.addEventListener('click', exportPng);

      els.qty.addEventListener('keydown', onKeyDown);
      els.price.addEventListener('keydown', onKeyDown);
      els.type.addEventListener('keydown', onKeyDown);

      onTypeChange();
      renderRows();
    });
  })();
  </script>
</body>
</html>
